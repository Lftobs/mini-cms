---
import DashboardLayout from "@/layouts/DashboardNewLayout.astro";
import { actions } from "astro:actions";

const currentUser = Astro.locals.currentUser;

if (!currentUser) {
	return Astro.redirect("/login");
}

const result = Astro.getActionResult(actions.usersActions.updateProfile);
const success = result?.data?.success;
const error = result?.error;

const updatedUser = result?.data?.user;
const displayUser = {
    username: updatedUser?.username ?? currentUser.username,
    email: updatedUser?.email ?? currentUser.email
};
---

<DashboardLayout title="Your Profile">
	<div class="space-y-6" slot="content">
		<div
			class="bg-white rounded-lg shadow-sm border border-earth-100 p-6 max-w-2xl mx-auto"
		>
			<h1 class="text-2xl font-semibold text-earth-400 mb-2">
				Your Profile
			</h1>
			<p class="text-earth-300 mb-6">
				Manage your account settings and preferences.
			</p>

			{
				success && (
					<div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center">
						<svg
							class="w-5 h-5 text-green-600 mr-3"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M5 13l4 4L19 7"
							/>
						</svg>
						<p class="text-sm text-green-700">
							Profile updated successfully.
						</p>
					</div>
				)
			}

			{
				error && (
					<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center">
						<svg
							class="w-5 h-5 text-red-600 mr-3"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
							/>
						</svg>
						<p class="text-sm text-red-700">
							{error.message ||
								"An error occurred while updating your profile."}
						</p>
					</div>
				)
			}

			<form
				method="POST"
				action={actions.usersActions.updateProfile}
				class="space-y-6"
			>
				<div class="space-y-4">
					<div>
						<label
							for="username"
							class="block text-sm font-medium text-earth-400 mb-1"
						>
							Username
						</label>
						<input
							type="text"
							id="username"
							name="username"
							value={displayUser.username || ""}
							class="w-full px-3 py-2 border border-earth-200 rounded-md focus:outline-none focus:ring-2 focus:ring-earth-400 focus:border-transparent text-earth-400"
							placeholder="Enter your username"
						/>
						<p class="mt-1 text-xs text-earth-200">
							This is your public display name.
						</p>
					</div>

					<div>
						<label
							for="email"
							class="block text-sm font-medium text-earth-400 mb-1"
						>
							Email Address
						</label>
						<input
							type="email"
							id="email"
							name="email"
							value={displayUser.email || ""}
							class="w-full px-3 py-2 border border-earth-200 rounded-md focus:outline-none focus:ring-2 focus:ring-earth-400 focus:border-transparent text-earth-400"
							placeholder="Enter your email address"
						/>
						<p class="mt-1 text-xs text-earth-200">
							We'll use this for account notifications.
						</p>
					</div>
				</div>

				<div class="pt-4 border-t border-earth-100 flex justify-end">
					<button
						type="submit"
						class="px-4 py-2 bg-earth-400 text-white font-medium rounded-md hover:bg-earth-300 transition-colors shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-earth-400"
					>
						Save Changes
					</button>
				</div>
			</form>
		</div>
	</div>
</DashboardLayout>
