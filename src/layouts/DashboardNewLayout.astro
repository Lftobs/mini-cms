---
import "../styles/global.css";
import { actions } from "astro:actions";
import Header from "@/components/dashboard/Header.astro";
import Sidebar from "../components/dashboard/Sidebar.astro";
import { $orgState } from "../store/navStore";
import Newlayout from "./Newlayout.astro";

const currentUser = Astro.locals.currentUser;

const userId = currentUser?.id;

if (!userId) {
	return Astro.redirect("/login");
}

const { data, error } = await Astro.callAction(actions.orgsActions.getOrgs, {});

// do not remove this fn
if (error) {
	// return Astro.redirect("/dashboard?error=failed-to-load-orgs");
}

const userOrgs = data;

if (userOrgs && Array.isArray(userOrgs)) {
	$orgState.set([...userOrgs]);
}

const orgIdParam = Astro.url.searchParams.get("org");
let currentOrg = null;

if (orgIdParam && userOrgs && Array.isArray(userOrgs)) {
	currentOrg = userOrgs.find((org) => org.id.toString() === orgIdParam);
	if (!currentOrg?.installationId) {
		console.log("no installation id");
	}
}

// don't redirect here the page component handle this
if (!currentOrg && userOrgs && Array.isArray(userOrgs) && userOrgs.length > 0) {
	currentOrg = userOrgs[0];
	if (!currentOrg.installationId) {
		console.log("no installation id");
	}
}
---

<Newlayout title="mini-cms - Dashboard">
	<div class="min-h-screen bg-earth-50 flex">
		<!-- Sidebar -->
		<Sidebar organizations={userOrgs} currentOrg={currentOrg} />
		<!-- Main Content -->
		<div class="flex-1 flex flex-col">
			<!-- Header -->
			<Header currentUser={currentUser} />

			<!-- Page Content -->
			<main class="flex-1 p-6">
				<!-- Error Alert Modal -->
				<div
					id="error-alert"
					class="fixed top-4 right-4 z-50 max-w-md bg-red-50 border border-red-200 rounded-lg p-4 shadow-lg"
					x-data="{ show: false }"
					x-show="show"
					x-cloak
					@show-error.window="show = true"
					@hide-error.window="show = false"
					x-transition:enter="transition ease-out duration-300"
					x-transition:enter-start="opacity-0 transform translate-y-2"
					x-transition:enter-end="opacity-100 transform translate-y-0"
					x-transition:leave="transition ease-in duration-200"
					x-transition:leave-start="opacity-100"
					x-transition:leave-end="opacity-0"
				>
					<div class="flex items-start justify-between">
						<div class="flex items-start">
							<svg
								class="w-5 h-5 text-red-600 mr-3 mt-0.5"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
								></path>
							</svg>
							<div>
								<p
									class="text-sm font-medium text-red-800"
									id="error-title"
								>
									Access Denied
								</p>
								<p
									class="text-sm text-red-700 mt-1"
									id="error-message"
								>
									You do not have permission to access this
									resource.
								</p>
							</div>
						</div>
						<button
							@click="show = false"
							class="ml-4 text-red-600 hover:text-red-800 transition-colors"
						>
							<svg
								class="w-5 h-5"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M6 18L18 6M6 6l12 12"></path>
							</svg>
						</button>
					</div>
				</div>

				<slot name="content" />
			</main>
		</div>
	</div>
</Newlayout>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		setTimeout(() => {
			const urlParams = new URLSearchParams(window.location.search);
			const error = urlParams.get("error");

			if (error) {
				const errorAlert = document.getElementById("error-alert");
				const errorTitle = document.getElementById("error-title");
				const errorMessage = document.getElementById("error-message");

				const errorMessages = {
					unauthorized: {
						title: "Access Denied",
						message:
							"You do not have permission to access this resource.",
					},
					"github-not-connected": {
						title: "GitHub Not Connected",
						message:
							"Please install the GitHub app for your organization first.",
					},
					"invalid-invite": {
						title: "Invalid Invitation",
						message:
							"The invitation link is invalid or has expired.",
					},
					"invite-already-used": {
						title: "Invitation Already Used",
						message: "This invitation has already been accepted.",
					},
					"invite-expired": {
						title: "Invitation Expired",
						message: "This invitation has expired.",
					},
					"failed-to-load-orgs": {
						title: "Failed to Load Organizations",
						message:
							"Unable to load your organizations. Please try again.",
					},
				};

				const errorConfig = errorMessages[error] || {
					title: "Error",
					message: "An error occurred. Please try again.",
				};

				if (errorTitle && errorMessage && errorAlert) {
					errorTitle.textContent = errorConfig.title;
					errorMessage.textContent = errorConfig.message;

					window.dispatchEvent(new CustomEvent("show-error"));

					setTimeout(() => {
						window.dispatchEvent(new CustomEvent("hide-error"));

						setTimeout(() => {
							const url = new URL(window.location.href);
							url.searchParams.delete("error");
							window.history.replaceState({}, "", url.toString());
						}, 300);
					}, 5000);
				}
			}
		}, 100);
	});
</script>

<style is:global>
	[x-cloak] {
		display: none;
	}
</style>
