---
import Layout from "@/layouts/DashboardNewLayout.astro";
import { db, eq, Invites, Projects, Orgs } from "astro:db";

const { token } = Astro.params;
const currentUser = Astro.locals.currentUser;

if (!token) {
    return Astro.redirect("/");
}

// Check if invite exists and is valid
const invite = await db
    .select({
        id: Invites.id,
        projectName: Projects.name,
        orgName: Orgs.name,
        status: Invites.status,
        expiresAt: Invites.expiresAt,
    })
    .from(Invites)
    .innerJoin(Projects, eq(Invites.projectId, Projects.id))
    .innerJoin(Orgs, eq(Projects.orgs_id, Orgs.id))
    .where(eq(Invites.token, token))
    .get();

if (!invite) {
    return Astro.redirect("/?error=invalid-invite");
}

if (invite.status !== "pending") {
    return Astro.redirect("/?error=invite-already-used");
}

if (new Date() > invite.expiresAt) {
    return Astro.redirect("/?error=invite-expired");
}

// If not logged in, redirect to login with return url
if (!currentUser) {
    return Astro.redirect(`/auth/login?next=/invite/${token}`);
}
---

<Layout>
    <div
        class="flex items-center justify-center min-h-screen bg-[#F7F5F3]"
        slot="content"
    >
        <div
            class="max-w-md w-full mx-4 space-y-6 p-8 bg-white rounded-xl shadow-lg border border-[#E6E4E1]"
        >
            <!-- Icon Header -->
            <div class="text-center">
                <div
                    class="w-16 h-16 bg-earth-100 rounded-full flex items-center justify-center mx-auto mb-4"
                >
                    <svg
                        class="w-8 h-8 text-earth-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M3 19v-8.93a2 2 0 01.89-1.664l7-4.666a2 2 0 012.22 0l7 4.666A2 2 0 0121 10.07V19M3 19a2 2 0 002 2h14a2 2 0 002-2M3 19l6.75-4.5M21 19l-6.75-4.5M3 10l6.75 4.5M21 10l-6.75 4.5m0 0l-1.14.76a2 2 0 01-2.22 0l-1.14-.76"
                        ></path>
                    </svg>
                </div>

                <h2 class="text-2xl font-bold text-earth-500">
                    Project Invitation
                </h2>
                <p class="mt-3 text-earth-300 text-sm leading-relaxed">
                    You've been invited to collaborate on
                </p>
            </div>

            <!-- Project Details -->
            <div class="bg-earth-50 rounded-lg p-4 border border-earth-100">
                <div class="space-y-2">
                    <div>
                        <span
                            class="text-xs text-earth-300 uppercase tracking-wide font-medium"
                            >Project</span
                        >
                        <p class="text-lg font-semibold text-earth-500 mt-1">
                            {invite.projectName}
                        </p>
                    </div>
                    <div>
                        <span
                            class="text-xs text-earth-300 uppercase tracking-wide font-medium"
                            >Organization</span
                        >
                        <p class="text-earth-400 mt-1">
                            {invite.orgName}
                        </p>
                    </div>
                    <div>
                        <span
                            class="text-xs text-earth-300 uppercase tracking-wide font-medium"
                            >Role</span
                        >
                        <p class="text-earth-400 mt-1">
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-earth-200 text-earth-600"
                            >
                                Editor
                            </span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Welcome Message -->
            <div class="text-center">
                <p class="text-sm text-earth-300">
                    You'll be able to edit and collaborate on this project as an <strong
                        class="text-earth-400">Editor</strong
                    >.
                </p>
            </div>

            <!-- Action Button -->
            <div class="space-y-3">
                <button
                    id="accept-btn"
                    class="w-full flex justify-center items-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-earth-500 hover:bg-earth-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-earth-500 transition-colors duration-200 shadow-sm"
                >
                    Accept Invitation
                </button>

                <a
                    href="/dashboard"
                    class="block text-center text-sm text-earth-300 hover:text-earth-400 transition-colors"
                >
                    Go to Dashboard
                </a>
            </div>
        </div>
    </div>
</Layout>

<script define:vars={{ token }}>
    const btn = document.getElementById("accept-btn");
    btn?.addEventListener("click", async () => {
        try {
            btn.innerText = "Accepting...";
            btn.disabled = true;

            const res = await fetch("/api/projects/invite/accept", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ token }),
            });

            if (res.ok) {
                window.location.href = "/dashboard";
            } else {
                const data = await res.json();
                alert(data.error || "Failed to accept invitation");
                btn.innerText = "Accept Invitation";
                btn.disabled = false;
            }
        } catch (e) {
            console.error(e);
            alert("An error occurred");
            btn.innerText = "Accept Invitation";
            btn.disabled = false;
        }
    });
</script>
