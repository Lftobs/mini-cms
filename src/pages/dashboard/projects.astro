---
import { actions } from "astro:actions";
import GitHubInstallationAlert from "@/components/dashboard/GitHubInstallationAlert.astro";
import DashboardLayout from "@/layouts/DashboardNewLayout.astro";
import {$orgState, currentOrgIdState } from "@/store/navStore";
import { userProjects } from "@/utils/cachedFn";

export const prerender = false;

const currentUser = Astro.locals.currentUser;
const userId = currentUser?.id;

let userOrgs = [];
const { data, error } = await Astro.callAction(actions.orgsActions.getOrgs, {});
if (!error && data) {
	userOrgs = data;
	$orgState.set(data)
}

const orgIdParam = Astro.url.searchParams.get("org");
let currentOrg = null;

if (orgIdParam && Array.isArray(userOrgs) && userOrgs.length > 0) {
	currentOrg = userOrgs.find((org) => org.id.toString() === orgIdParam);
	if (currentOrg) {
		currentOrgIdState.set(currentOrg.id);
	}
}

if (!currentOrg && !orgIdParam) {
	const currentOrgId = currentOrgIdState.get();
	if (currentOrgId && Array.isArray(userOrgs)) {
		currentOrg = userOrgs.find((org) => org.id === currentOrgId);
	}
}

if (!currentOrg && Array.isArray(userOrgs) && userOrgs.length > 0) {
	currentOrg = userOrgs[0];
	currentOrgIdState.set(currentOrg.id);

	return Astro.redirect("/dashboard/projects?org=" + currentOrg.id);
}

const userName = currentUser?.username;

const needsGitHubInstallation = !currentOrg?.installationId;

let projects: any[] = [];
if (currentOrg && userId) {
	try {
		const projectsResponse = await userProjects.fetch(userId);
		const projectsData = projectsResponse?.data;
		if (projectsData) {
			projects = projectsData.filter(
				(project: { org_id: any; }) => project.org_id === currentOrg.id,
			);
		}
	} catch (error) {
		console.error("Error fetching projects:", error);
	}
}
---

<DashboardLayout userOrgs={userOrgs} currentOrg={currentOrg}>
	<div class="space-y-6" slot="content">
		{
			userOrgs && userOrgs.length > 0 ? (
				<>
					<GitHubInstallationAlert
						installationSuccessMessage=""
						installationErrorMessage=""
						needsGitHubInstallation={needsGitHubInstallation}
						currentOrgId={currentOrg?.id}
					/>

					{/* Header */}
					<div class="bg-white rounded-lg shadow-sm border border-earth-100 p-6">
						<div class="flex items-center justify-between">
							<div>
								<h1 class="text-2xl font-semibold text-earth-400 mb-2">
									All Projects
								</h1>
								<p class="text-earth-300">
									Manage all your projects in{" "}
									<span class="inline-block bg-earth-accent-light/50 font-bold text-earth-500 px-2 py-1 rounded-full text-xs">
										{currentOrg?.name || "your organization"}
									</span>
								</p>
							</div>
							<a
								href={`/dashboard/project/new${orgIdParam ? `?org=${orgIdParam}` : ""}`}
								class="inline-flex items-center px-4 py-2 bg-earth-400 text-white font-medium rounded-lg hover:bg-earth-300 transition-colors"
							>
								<svg
									class="w-5 h-5 mr-2"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M12 6v6m0 0v6m0-6h6m-6 0H6"
									/>
								</svg>
								New Project
							</a>
						</div>
					</div>

					{/* Projects List */}
					<div class="bg-white rounded-lg shadow-sm border border-earth-100 p-6">
						{projects.length > 0 ? (
							<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
								{projects.map((project) => (
									<div class="bg-earth-50 rounded-lg p-4 border border-earth-100 hover:border-earth-200 transition-colors">
										<div class="flex items-start justify-between">
											<div class="flex-1">
												<h3 class="font-medium text-earth-400 mb-1">
													{project.name || "Unnamed Project"}
												</h3>
												<p class="text-sm text-earth-300">
													{project.description || "No description"}
												</p>
											</div>
											<div class="flex space-x-2 ml-2">
												{project.github_repo_link && (
													<a
														href={project.github_repo_link}
														target="_blank"
														rel="noopener noreferrer"
														class="inline-flex items-center px-2 py-1 text-xs font-medium text-earth-400 bg-white border border-earth-200 rounded-md hover:bg-earth-50 transition-colors"
													>
														<svg
															class="w-3 h-3 mr-1"
															fill="currentColor"
															viewBox="0 0 24 24"
														>
															<path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
														</svg>
														View Repo
													</a>
												)}
												<a
													href={`/dashboard/project/edit/${project.id}`}
													class="inline-flex items-center px-2 py-1 text-xs font-medium text-white bg-earth-400 border border-earth-400 rounded-md hover:bg-earth-300 transition-colors"
												>
													<svg
														class="w-3 h-3 mr-1"
														fill="none"
														stroke="currentColor"
														viewBox="0 0 24 24"
													>
														<path
															stroke-linecap="round"
															stroke-linejoin="round"
															stroke-width="2"
															d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
														/>
													</svg>
													Edit
												</a>
											</div>
										</div>
									</div>
								))}
							</div>
						) : (
							<div class="text-center py-8">
								<svg
									class="w-12 h-12 text-earth-200 mx-auto mb-4"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
									/>
								</svg>
								<p class="text-earth-300 mb-2">
									No projects yet
								</p>
								<p class="text-sm text-earth-200">
									Create your first project to get started
								</p>
							</div>
						)}
					</div>
				</>
			) : (
				<div class="flex flex-col items-center justify-center min-h-[60vh] text-center">
					<div class="bg-white p-8 rounded-lg shadow-sm border border-earth-100 max-w-lg w-full">
						<div class="w-16 h-16 bg-earth-50 rounded-full flex items-center justify-center mx-auto mb-6">
							<svg
								class="w-8 h-8 text-earth-400"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
								/>
							</svg>
						</div>
						<h2 class="text-2xl font-bold text-earth-400 mb-3">
							Welcome to Collab-X!
						</h2>
						<p class="text-earth-300 mb-8">
							You don't have any organizations yet. Create one to
							get started with your projects and team
							collaboration.
						</p>
						<a
							href="/dashboard/org/new"
							class="inline-flex items-center px-6 py-3 bg-earth-400 text-white font-medium rounded-lg hover:bg-earth-300 transition-colors shadow-sm"
						>
							<svg
								class="w-5 h-5 mr-2"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M12 6v6m0 0v6m0-6h6m-6 0H6"
								/>
							</svg>
							Create Organization
						</a>
					</div>
				</div>
			)
		}
	</div>
</DashboardLayout>
